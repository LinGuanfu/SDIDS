<!DOCTYPE html>
<html lang="en">

<head>
  <meta name="description" content="Structural health monitoring">
  <title>结构健康监测系统</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Main CSS-->
  <link rel="stylesheet" type="text/css" href="css/main.css">
  <!-- Font-icon css-->
  <link rel="stylesheet" type="text/css" href="css/font-awesome.css">
  <script type='text/javascript' src='/eel.js'></script>
</head>


<body class="app sidebar-mini rtl">
  <!-- Navbar-->
  <header class="app-header">
    <a class="app-header__logo" href="#">结构健康监测系统</a>
    <!-- Sidebar toggle button-->
    <a class="app-sidebar__toggle" href="#" data-toggle="sidebar" aria-label="Hide Sidebar"></a>
  </header>

  <!-- 可视化部分菜单 Sidebar menu -->
  <div class="app-sidebar__overlay" data-toggle="sidebar"> </div>
  <aside class="app-sidebar">
    <ul class="app-menu">
      <li class="treeview">
      <li class="treeview is-expanded"><a class="app-menu__item" href="index.html"><i
            class="app-menu__icon fa fa-laptop"></i><span class="app-menu__label">图表可视化</span><i
            class="treeview-indicator fa fa-angle-right"></i></a>
        <ul class="treeview-menu">
          <li><a class="treeview-item" href="storey.html"><i class="icon fa fa-cube"></i>剪切层模型</a></li>
          <li><a class="treeview-item active" href="beam.html"><i class="icon fa fa-cube"></i>悬臂梁模型</a>
          </li>
        </ul>
      </li>
    </ul>
  </aside>



  <!-- body 中的 main 部分。也就是可视化的图表等 Sidebar menu -->
  <main class="app-content">

    <!-- main里面的第一行，表面这一行是什么内容。便于下面进行分析 -->
    <div class="app-title">
      <div>
        <h1><i class="app-menu__icon fa fa-laptop"></i> 图表可视化---悬臂梁模型 </h1>
        <p>清晰、直观、立体的结构健康健康监测数据展示平台</p>
      </div>
    </div>

    <!-- %%%%%%%%%%%%%%%%%%%%%%%  以下是main里面的 主体部分， 比如数据的读取 可视化等  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% -->

    <div class="container-fluid ">
      <div class="row">

        <div class="col-md-8">

            <div class="tile">
              <h4 class="tile-title">结构示意图</h4>
              <div id="boxdrawing" style="height: 25%; width: 100% ;margin: 0;padding: 0;">
                <canvas id="drawshap"
                  style="height: 100%;width: 100%;margin: 0;padding: 0;;border:5px solid; border-color: crimson"></canvas>
              </div>
            </div>
        
            <div class="tile">
              <h4 class="tile-title">损伤识别结果</h4>
              <div id="boxdrawing2" style="height: 25%; width: 100% ;margin: 0;padding: 0;">
                <canvas id="drawbar"
                  style="height: 100%;width: 100%;margin: 0;padding: 0;;border:5px solid; border-color: crimson"></canvas>
              </div>
            </div>

        </div>

        <div class="col-md-4">
          <div class="tile">
            <h4 class="tile-title">输入控制面板</h4>
            <div class="row border rounded">
              <div class="col-md-12" style="padding: 0 0 0 0">
                <strong>
                  <p class="p-2 bg-success text-center" style="color: white">Input Form</p>
                </strong>
              </div>
              <div class="col-md-12 form-group">
                <strong class="text-muted mb-1">
                  <label for="numelem">Number of element</label>
                </strong>
                <input onclick="clearCanvas()" type="number" class="form-control" id="numelem" placeholder="Number of element" , value="20">
              </div>
              <div class="col-md-12">
                <strong class="text-muted mb-1">
                  <label class="control-label">Select Data</label>
                </strong>
                <div class="form-group">
                  <span>
                    <button type="submit" class="btn btn-primary" value="getdatafile" id="submitbtn">
                      Select
                    </button>
                  </span>
                  <span class="submitWord">No selected files.</span>
                </div>
              </div>
              <div class="col-md-6 form-group">
                <span>
                  <strong class="text-muted mb-1">
                    <label for="MeasuredNodes">Measured Nodes</label>
                  </strong>
                </span>
                <input type="text" class="form-control" id="MeasuredNodes" placeholder="MeasuredNodes" value="[20]">
              </div>
              <div class="col-md-6 form-group">
                <span>
                  <strong class="text-muted mb-1">
                    <label for="orderuse">Order of Data</label>
                  </strong>
                </span>
                <input type="text" class="form-control" id="orderuse" placeholder="orderuse" value="[1,2,3,4,5,6]">
              </div>
              <div class="col-md-6 form-group">
                <span>
                  <strong class="text-muted mb-1">
                    <label for="DirDOF">Fixed Degree of Freedoms</label>
                  </strong>
                </span>
                <input type="text" class="form-control" id="DirDOF" placeholder="DirDOF" value="[1,2]">
              </div>
              <div class="col-md-6 form-group">
                <span>
                  <strong class="text-muted mb-1">
                    <label for="TolLen">Toltal Length of the Beam</label>
                  </strong>
                </span>
                <input type="text" class="form-control" id="TolLen" placeholder="TolLen" value="0.4953">
              </div>
              <div class="col-md-6 form-group">
                <span>
                  <strong class="text-muted mb-1">
                    <label for="beamE">E</label>
                  </strong>
                </span>
                <input type="text" class="form-control" id="beamE" placeholder="beamE" value="7.1e10">
              </div>
              <div class="col-md-6 form-group">
                <span>
                  <strong class="text-muted mb-1">
                    <label for="rho">Density</label>
                  </strong>
                </span>
                <input type="text" class="form-control" id="rho" placeholder="rho" value="2.21e3">
              </div>
              <div class="col-md-6 form-group">
                <span>
                  <strong class="text-muted mb-1">
                    <label for="Im">Im</label>
                  </strong>
                </span>
                <input type="text" class="form-control" id="Im" placeholder="Im" value="5.419680020833333e-10">
              </div>
              <div class="col-md-6 form-group">
                <span>
                  <strong class="text-muted mb-1">
                    <label for="area">Area</label>
                  </strong>
                </span>
                <input type="text" class="form-control" id="area" placeholder="area" value="1.6129e-4">
              </div>
              <div class="col-md-6 form-group">
                <span>
                  <strong class="text-muted mb-1">
                    <label for="tol">Tolerance of Convergence Criteria</label>
                  </strong>
                </span>
                <input type="text" class="form-control" id="tol" placeholder="tol" value="1e-6">
              </div>
              <div class="col-md-6 form-group">
                <span>
                  <strong class="text-muted mb-1">
                    <label for="nmax">Maximum Number of Iteration</label>
                  </strong>
                </span>
                <input type="text" class="form-control" id="nmax" placeholder="nmax" value="1000">
              </div>
              <div class="col-md-6 form-group">
                <strong class="text-muted mb-1">
                  <label for="modeltype">Model Type</label>
                </strong>
                <select class="form-control" id="modeltype">
                  <option>Beam</option>
                  <option>Storey</option>
                  <option>Shell</option>
                  <option>Truss</option>
                  <option>Frame</option>
                </select>
              </div>
              <div class="col-md-6 form-group">
                <strong class="text-muted mb-1">
                  <label for="goaltype">Goal Type</label>
                </strong>
                <select class="form-control" id="goaltype">
                  <option>Decoupled</option>
                  <option>Coupled</option>
                </select>
              </div>
              <div class="col-md-12 form-group">
                <strong class="text-muted mb-2">Regularization</strong>
                <fieldset>
                  <ul>
                    <div class="custom-control custom-radio mb-1">
                      <input type="radio" id="L1reg" name="regularization" class="custom-control-input regularization"
                        value="L1" checked>
                      <label class="custom-control-label" for="L1reg">L-1 (default)</label>
                    </div>
                    <div class="row reg-group" id="L1-reg-group">
                      <div class="col-md-6 form-group">
                        <strong class="text-muted mb-1">
                          <label for="alpha">&#945;</label>
                        </strong>
                        <input type="number" class="form-control" name="L1-alpha" id="L1-alpha" value="100">
                      </div>
                      <div class="col-md-6 form-group">
                        <strong class="text-muted mb-1">
                          <label for="lmax">L-max</label>
                        </strong>
                        <input type="number" class="form-control" name="L1-lmax" id="L1-lmax" value="4">
                      </div>
                    </div>
                    <div class="custom-control custom-radio mb-1">
                      <input type="radio" id="L2reg" name="regularization" class="custom-control-input regularization"
                        value="L2">
                      <label class="custom-control-label" for="L2reg">L-2 </label>
                    </div>
                    <div class="custom-control custom-radio mb-1">
                      <input type="radio" id="noreg" name="regularization" class="custom-control-input regularization" value="">
                      <label class="custom-control-label" for="noreg">none </label>
                    </div>
                  </ul>
                </fieldset>
              </div>
        
              <div class="col-md-6 p-2">
                <button  class="btn btn-primary btn-block" id="Create">Create</button>
              </div>
              <div class="col-md-6 p-2">
                <button class="btn btn-primary btn-block" id="Calculate">Calculate</button>
              </div>
            </div>
        
        
        
          </div>
        </div>
      </div>
    </div>
  </main>

    <!-- %%%%%%%%%%%%%%%%%%%%%%%  以上是是主体部分， 比如数据的读取 可视化等  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% -->

  <!-- Essential javascripts for application to work-->
  <script src="js/jquery-3.4.1.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/main.js"></script>
  <script type="text/javascript" src="js/chart.js"></script>

  <!-- %%%%%%%%%%%%%%%%%%  画图额外添加的 js   %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% -->
  <script src="js/d3.js"></script>
  <!-- two.js 核心 js 文件 -->
  <script src="js/two.min.js"></script>
  <!-- eel (连接python和web实现数据交换的关键库) js 文件 -->
  <!-- <script type='text/javascript' src='/eel.js'></script> -->


  <script>
    // 检查类型是radio(type="radio"),属于regularization类(class="regularization")的input标签
    // 有没有被选中(checked)，没有被选中的话让它父元素的下一个属于reg-group类(class="reg-group")的
    // div 标签隐藏。
    $("input.regularization:radio:not(:checked)").parent().next('div.reg-group').hide();
    // 检查类型是radio(type="radio"),属于regularization类(class="regularization")的input标签
    // 是不是在变化，如果有变化，则判断变化的这个(this)标签是否被选中(checked)了，如果选中了，则让
    // 这个标签(this)的父元素的下一个属于reg-group类(class="reg-group")的div标签显示出来，并将其他
    // 除了这个标签外的，类型是radio(type="radio"),属于regularization类(class="regularization")
    // 的input标签的父元素的下一个属于reg-group类(class="reg-group")的div标签隐藏。
    $("input.regularization:radio").change(function () {
      if ($(this).is(':checked')) {
        $(this).parent().next('div.reg-group').show();
        $('input.regularization:radio').not(this).parent().next('div.reg-group').hide();
      }
    });

    // %%%%%%%%%%%%%%%%%%%%  creat 作结构图 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
      function clearCanvas() {
            drawshap.height = drawshap.height;
        
      }   // 

      $(document).ready(
        $("#Create").click(
          async function () {       // 先判断是否已经画图了，如果已经画图了的画，刷新这幅图即可。如果没有画图的画，就进入画图换届
              
              var numelem = Number($("#numelem").val());					// 单元数。
              var drawshap = document.getElementById('drawshap'); // getElementById 动态选择器
              var ctx = drawshap.getContext("2d");   //获取二维画图地方
              var height = window.getComputedStyle(boxdrawing2).height; // 获取div  id="boxdrawing" 的长宽
              var width = window.getComputedStyle(boxdrawing2).width;
              drawshap.width = width.split("px")[0];
              drawshap.height = height.split("px")[0];

            lenEle= (drawshap.width-30)/numelem;      // 第一行
            higEle= (drawshap.height-10)/6;
            ctx.moveTo(15, drawshap.height/2-higEle/2);       //设置起点状态
            ctx.lineTo( (drawshap.width-30),  drawshap.height/2-higEle/2 );       //设置末端状态
            ctx.lineWidth = 5;          //设置线宽状态
            ctx.strokeStyle="green";
            ctx.stroke();               //进行绘制
                                                                          // 第二行
             ctx.moveTo(15, drawshap.height/2+higEle/2);       //设置起点状态
            ctx.lineTo( (drawshap.width-30),  drawshap.height/2+higEle/2 );       //设置末端状态
            ctx.lineWidth = 5;          //设置线宽状态
            ctx.strokeStyle="green";
            ctx.stroke();               //进行绘制
            

            for (i = 0; i < numelem; i++) {
       
            ctx.moveTo( lenEle*(i+1),  drawshap.height/2-higEle/2 );       //设置末端状态
            ctx.lineTo( lenEle*(i+1),  drawshap.height/2+higEle/2 );       //设置末端状态
            ctx.lineWidth = 5;          //设置线宽状态
            ctx.strokeStyle="green";
            ctx.stroke();               //进行绘制
        }

        ctx.fillStyle = 'rgb(0, 0, 0)';
        ctx.fillRect(15, drawshap.height/2-(drawshap.height-10)/4/2, 5, (drawshap.height-10)/4);   // 填充背景，测试



        }  // async function
        
      )
    );



    // %%%%%%%%%%%%%%%%%%%% Calculate  计算结果图 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    $(document).ready(
      $("#Calculate").click(
        async function () {	
          // 获取所有需要用到的参数。
          var csvfile = localStorage.getItem("csvfile");  	// 文件路径。
          var numelem = Number($("#numelem").val());					// 单元数。
          var modeltype = $("#modeltype").val();				// 模型类型。
          var goaltype = $("#goaltype").val();				// 目标函数类型。
          var MeasuredNodes = JSON.parse($("#MeasuredNodes").val());		// 测点。
          var orderuse = JSON.parse($("#orderuse").val());  // 用到的频率阶数。
          var DirDOF = JSON.parse($("#DirDOF").val());      // 固定的自由度。
          var TolLen = Number($("#TolLen").val());          // 梁的总长度。
          var rho = Number($("#rho").val());                // 密度。
          var E = Number($("#beamE").val());	              // 弹性模量。
          var area = Number($("#area").val());              // 梁横截面积。
          var Im = Number($("#Im").val());                  // 梁截面惯性矩。
          var tol = Number($("#tol").val());                // 收敛标准的容许误差。
          var nmax = Number($("#nmax").val());              // 最大迭代步数。
          // 检查是否采用正则化。
          if ($("#L1reg").is(':checked')) {
          	// 获取 L1 正则化需要的超参数。
          	var alpha = Number($("#L1-alpha").val());
          	var lmax = Number($("#L1-lmax").val());
          	// 控制台输出参数，以便查看数据类型和数据是否正确。
          	// console.log('numelem:',typeof numelem);
          	// console.log(numelem);
          	// console.log('modeltype:',typeof modeltype);
          	// console.log(modeltype);
          	// console.log('goaltype:',typeof goaltype);
          	// console.log(goaltype);
          	// console.log('MeasuredNodes:',typeof MeasuredNodes);
          	// console.log(MeasuredNodes);
          	// console.log('orderuse:',typeof orderuse);
          	// console.log(orderuse);
          	// console.log('alpha:',typeof alpha);
          	// console.log(alpha);
          	// console.log('lmax:',typeof lmax);
          	// console.log(lmax);
            // console.log('tol:',typeof tol);
            // console.log(tol);
            // console.log('nmax:',typeof nmax);
            // console.log(nmax);
          // 调用后台python的BeamDetect函数进行损伤计算并保存返回的结果于stiff。


// var stiff = await eel.BeamDetect(modeltype,goaltype,csvfile,numelem,MeasuredNodes,orderuse,DirDOF,TolLen,E,rho,area,Im,lmax,alpha,tol,nmax)();
          // // 控制台输出结果，检查是否正确。
          // console.log(stiff)
          // console.log(typeof stiff)

          } else { 
          //     //如果不进行正则化，有待完成...
          // 	console.log(dof,modeltype,goaltype,MeasuredNodes,orderuse);
          }


//%%%%%%%%%%%%%以上是数据输入计算。以下是stiff显示%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
      var numelem = 8;
       stiff = [{ 'dof': 1, 'value': 1.00 }, { 'dof': 2, 'value': 1.00 },
           { 'dof': 3, 'value': 2.00 }, { 'dof': 4, 'value': 1.00 },
           { 'dof': 5, 'value': 0.90 }, { 'dof': 6, 'value': 1.00 },
          { 'dof': 7, 'value': 1.50 }, { 'dof': 8, 'value': 3.00 }];
      var stiffvalue= new Array(numelem)
        for (i = 0; i < stiff.length; i++) {
          stiffvalue[i] = stiff[i].value;
        }
     var sx = Array.from({length:numelem},(item, index)=> index+1);
      var data = {
      	labels: sx,
      	datasets: [
          {
      			label: "My Second dataset",
      			fillColor: "rgba(0,204,255,0.2)",
      			strokeColor: "rgba(220,220,220,1)",
      			pointColor: "rgba(220,220,220,1)",
      			pointStrokeColor: "#fff",
      			pointHighlightFill: "#fff",
      			pointHighlightStroke: "rgba(220,220,220,1)",
      			data: stiffvalue,
      		}
      	]
      };
      var drawbar= document.getElementById('drawbar'); // getElementById 动态选择器
      var ctxb=drawbar.getContext("2d");   //获取二维画图地方
       var drawbar = new Chart(ctxb).Bar(data);
        } // click 下的function
      )
    );

    // %%%%%%%%%%%%%%%%%%%%%%%%%%%获取文件路径。 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    $(document).ready(
      $("#submitbtn").click(async function () {
        var filepath = await eel.getPath()();
        var extStart = filepath.lastIndexOf('.');
        ext = filepath.substring(extStart, filepath.length).toUpperCase();
        if (ext !== '.CSV') {
          $('.submitWord').html("上传文件出错！");
        } else {
          localStorage.setItem("csvfile", filepath);
          $('.submitWord').html(filepath);
          console.log(localStorage.getItem("csvfile"));
        }
      })
    );

  </script>

</body>

</html>