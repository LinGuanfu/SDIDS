<!DOCTYPE html>
<html lang="en">

<head>
  <meta name="description" content="Structural health monitoring">
  <title>结构健康监测系统</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Main CSS-->
  <link rel="stylesheet" type="text/css" href="css/main.css">
  <!-- Font-icon css-->
  <link rel="stylesheet" type="text/css" href="css/font-awesome.css">
  <script type='text/javascript' src='/eel.js'></script>
</head>


<body class="app sidebar-mini rtl">
  <!-- Navbar-->
  <header class="app-header">
    <a class="app-header__logo" href="#">结构健康监测系统</a>
    <!-- Sidebar toggle button-->
    <a class="app-sidebar__toggle" href="#" data-toggle="sidebar" aria-label="Hide Sidebar"></a>
  </header>

  <!-- 菜单 -->
  <div class="app-sidebar__overlay" data-toggle="sidebar"> </div>
  <aside class="app-sidebar">
    <ul class="app-menu">
      <li class="treeview">
      <li class="treeview is-expanded"><a class="app-menu__item" href="index.html"><i
            class="app-menu__icon fa fa-laptop"></i><span class="app-menu__label">模型</span><i
            class="treeview-indicator fa fa-angle-right"></i></a>
        <ul class="treeview-menu">
          <li><a class="treeview-item" href="storey.html"><i class="icon fa fa-cube"></i>剪切层模型</a></li>
          <li><a class="treeview-item active" href="beam.html"><i class="icon fa fa-cube"></i>悬臂梁模型</a>
          </li>
        </ul>
      </li>
    </ul>
  </aside>
  <main class="app-content">
    <div class="app-title">
      <div>
        <h1><i class="app-menu__icon fa fa-laptop"></i> 悬臂梁模型 </h1>
      </div>
    </div>
    <div class="container-fluid ">
      <div class="row">
        <div class="col-md-4" >
          <div class="row">
            <div class="col-md-12 form-group">
              <strong class="text-muted mb-1">
                <label for="numelem">梁自由度数</label>
              </strong>
              <input type="number" class="form-control" id="numelem" placeholder="Number of element", value="20">
            </div>
            <div class="col-md-12">
              <strong class="text-muted mb-1">
                <label class="control-label">选择数据</label>
              </strong>
              <div class="form-group">
                <span>
                  <button type="submit" class="btn btn-primary" value="getdatafile" id="submitbtn">
                    Select
                  </button>
                </span>
                <span class="submitWord">未选取数据</span>
              </div>
            </div>
            <div class="col-md-6 form-group">
              <span>
                <strong class="text-muted mb-1">
                  <label for="MeasuredNodes">测点编号</label>
                </strong>
              </span>
              <input type="text" class="form-control" id="MeasuredNodes" placeholder="MeasuredNodes" value="[20]">
            </div>
          <div class="col-md-6 form-group">
            <span>
            <strong class="text-muted mb-1">
              <label for="orderuse">数据阶数</label>
            </strong>
            </span>
            <input type="text" class="form-control" id="orderuse" placeholder="orderuse" value="[1,2,3,4,5,6]">
          </div>
          <div class="col-md-6 form-group">
            <span>
            <strong class="text-muted mb-1">
              <label for="DirDOF">约束编号</label>
            </strong>
            </span>
            <input type="text" class="form-control" id="DirDOF" placeholder="DirDOF" value="[1,2]">
          </div>
          <div class="col-md-6 form-group">
            <span>
            <strong class="text-muted mb-1">
              <label for="TolLen">梁总长度</label>
            </strong>
            </span>
            <input type="text" class="form-control" id="TolLen" placeholder="TolLen" value="0.4953">
          </div>
            <div class="col-md-6 form-group">
              <span>
                <strong class="text-muted mb-1">
                  <label for="beamE">弹性模量 E</label>
                </strong>
              </span>
              <input type="text" class="form-control" id="beamE" placeholder="beamE" value="7.1e10">
            </div>
            <div class="col-md-6 form-group">
              <span>
                <strong class="text-muted mb-1">
                  <label for="rho">密度 &#961;</label>
                </strong>
              </span>
              <input type="text" class="form-control" id="rho" placeholder="rho" value="2.21e3">
            </div>
            <div class="col-md-6 form-group">
              <span>
                <strong class="text-muted mb-1">
                  <label for="Im">截面惯性矩 Im</label>
                </strong>
              </span>
              <input type="text" class="form-control" id="Im" placeholder="Im" value="5.419680020833333e-10">
            </div>
            <div class="col-md-6 form-group">
              <span>
                <strong class="text-muted mb-1">
                  <label for="area">横截面积</label>
                </strong>
              </span>
              <input type="text" class="form-control" id="area" placeholder="area" value="1.6129e-4">
            </div>
          <div class="col-md-6 form-group">
            <span>
            <strong class="text-muted mb-1">
              <label for="tol">收敛因子</label>
            </strong>
            </span>
            <input type="text" class="form-control" id="tol" placeholder="tol" value="1e-6"> 
          </div>
          <div class="col-md-6 form-group">
            <span>
            <strong class="text-muted mb-1">
              <label for="nmax">最大迭代步数</label>
            </strong>
            </span>
            <input type="text" class="form-control" id="nmax" placeholder="nmax" value="1000"> 
          </div>
            <div class="col-md-6 form-group">
              <strong class="text-muted mb-1">
                <label for="modeltype">模型类型</label>						
              </strong>
              <select class="form-control" id="modeltype">
                <option>悬臂梁</option>
                <option>剪切层</option>
              </select>		
            </div> 
            <div class="col-md-6 form-group">
              <strong class="text-muted mb-1">
                <label for="goaltype">目标函数类型</label>
              </strong>
              <select class="form-control" id="goaltype">
                <option>解耦型</option>
                <option>耦合型</option>
              </select>
            </div>
            <div class="col-md-12 form-group">
              <strong class="text-muted mb-2">正则化</strong>
              <fieldset>
                <ul>
                  <div class="custom-control custom-radio mb-1">
                    <input type="radio" id="L1reg" name="regularization" class="custom-control-input regularization"
                      value="L1" checked>
                    <label class="custom-control-label" for="L1reg">L-1 (默认)</label>
                  </div>
                  <div class="row reg-group" id="L1-reg-group">
                    <div class="col-md-6 form-group">
                      <strong class="text-muted mb-1">
                        <label for="alpha">&#945;</label>
                      </strong>
                      <input type="number" class="form-control" name="L1-alpha" id="L1-alpha" value="100">
                    </div>
                    <div class="col-md-6 form-group">
                      <strong class="text-muted mb-1">
                        <label for="lmax">L-max</label>
                      </strong>
                      <input type="number" class="form-control" name="L1-lmax" id="L1-lmax" value="4">
                    </div>
                  </div>
                  <div class="custom-control custom-radio mb-1">
                    <input type="radio" id="L2reg" name="regularization" class="custom-control-input regularization"
                      value="L2">
                    <label class="custom-control-label" for="L2reg">L-2 </label>
                  </div>
                  <div class="custom-control custom-radio mb-1">
                    <input type="radio" id="noreg" name="regularization" class="custom-control-input regularization"
                      value="">
                    <label class="custom-control-label" for="noreg">不采用正则化 </label>
                  </div>
                </ul>
              </fieldset>
            </div>

            <div class="col-md-6 p-2">
              <button class="btn btn-primary btn-block" id="Create">创建模型</button>
            </div>
            <div class="col-md-6 p-2">
              <button class="btn btn-primary btn-block" id="Calculate">计算损伤</button>
            </div>
          </div>
        </div>
        <div class="col-md-8">
          <div class="col-md-12 " id="draw-shapes"></div>
          <div class="col-md-12 " id="draw-bar" ></div> 
        </div>
      </div>
    </div>
  </main>

  <!-- Essential javascripts for application to work-->
  <script src="js/jquery-3.4.1.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/main.js"></script>
  <script src="js/d3.js"></script>
  <script src="js/two.min.js"></script>
  <!-- eel (连接python和web实现数据交换的关键库) js 文件 -->
  <!-- <script type='text/javascript' src='/eel.js'></script> -->


  <script>
    // 检查类型是radio(type="radio"),属于regularization类(class="regularization")的input标签
    // 有没有被选中(checked)，没有被选中的话让它父元素的下一个属于reg-group类(class="reg-group")的
    // div 标签隐藏。
    $("input.regularization:radio:not(:checked)").parent().next('div.reg-group').hide();
    // 检查类型是radio(type="radio"),属于regularization类(class="regularization")的input标签
    // 是不是在变化，如果有变化，则判断变化的这个(this)标签是否被选中(checked)了，如果选中了，则让
    // 这个标签(this)的父元素的下一个属于reg-group类(class="reg-group")的div标签显示出来，并将其他
    // 除了这个标签外的，类型是radio(type="radio"),属于regularization类(class="regularization")
    // 的input标签的父元素的下一个属于reg-group类(class="reg-group")的div标签隐藏。
    $("input.regularization:radio").change(function () {
      if ($(this).is(':checked')) {
        $(this).parent().next('div.reg-group').show();
        $('input.regularization:radio').not(this).parent().next('div.reg-group').hide();
      }
    });

    // 定义一些作图相关的全局变量。
    var topp; // 画框顶部与图像的距离(像素)。
    var dof;  // 画图需要的自由度个数。
    var len;  // 画剪切层模型每一层长度(像素)。

    // ======================================================================
    //                                                                      |
    //                            创建剪切层模型                              |
    //                                                                      |
    // ------------------------------ 功能 ----------------------------------
    //                                                                      |
    // 当你输入DOF并按下 Create 按钮时候 ---> 画出相应的楼层	                  |
    //                                                                      |
    // ------------------------------ 参考 ----------------------------------
    //                                                                      |
    // 全程使用 two.js 库 https://two.js.org/，建议细读文档与例子看懂下面的代码 |
    //                                                                      |
    // ======================================================================
    $(document).ready(
      $("#Create").click(
        async function () {
          // 清空 #draw-shapes。
          $("#draw-shapes").empty();
          // 创建 TWO 实例. (具体参考 two.js 库的文档 https://two.js.org/#documentation)
          var elem = $('#draw-shapes').get(0);
          var boxwidth = $("#draw-shapes").width();
          var boxheight = $("#draw-shapes").width();
          var params = { width: boxwidth, height: boxheight };
          var two = new Two(params).appendTo(elem);

          // 创建线的组合.
          var vergroup = [];
          var horgroup = [];
          var buttomgroup = [];

          dof = await $("#numelem").val();           // 获取自由度的输入。
          len = Math.round((boxheight - 100) / dof); // 每层多长(像素)。
          var dx = (boxwidth-len) / 2;               // 距离左端div边界的长度(像素)。
          var dy = 30;                               // 距离底端div边界的长度(像素)。
          var outer = len / 2;                       // 地面超出横向楼板的长度(像素)。
          var bottomx = 10;                          // 地面小斜线对边的长度(像素)。
          topp = boxheight - dof * len - dy;

          // 创建柱子和楼板。
          for (var n = 0; n < dof; n++) {
            vergroup.push(two.makeLine(dx, dy + len * n, dx, dy + len * (n + 1)));
            vergroup.push(two.makeLine(dx + len, dy + len * n, dx + len, dy + len * (n + 1)));
            horgroup.push(two.makeLine(dx, dy + len * (n + 1), dx + len, dy + len * (n + 1)));
          }

          // 组合楼板并上色。
          var verticaLine = two.makeGroup(vergroup);
          verticaLine.linewidth = 5;
          verticaLine.stroke = 'rgb(1,0,0)';
          verticaLine.cap = 'round';

          // 组合柱子并上色。
          var horizontalLine = two.makeGroup(horgroup);
          horizontalLine.linewidth = 5;
          horizontalLine.stroke = 'rgb(1,0,0)';
          horizontalLine.cap = 'round';

          // 画地面。
          var baseline = two.makeLine(dx - outer, dy, dx + len + outer, dy);
          baseline.linewidth = 6;
          for (var ddx = dx - outer; ddx <= dx + len + outer - bottomx; ddx = ddx + bottomx) {
            buttomgroup.push(two.makeLine(ddx, dy - bottomx, ddx + bottomx, dy));
          }
          var buttomLine = two.makeGroup(buttomgroup);
          buttomLine.linewidth = 3;

          // 组合所有线条。
          var temp1 = vergroup.concat(horgroup)
          var temp2 = temp1.concat(buttomgroup)
          var totalgroup = temp2.concat(baseline)
          var totalLine = two.makeGroup(totalgroup)

          // 所有东西旋转180度。
          totalLine.translation.set(10,600);
          totalLine.rotation = -Math.PI/2;
          
          // damage index color generator.
          // var b = d3.rgb(50,200,255);	//蓝色
          // var a = d3.rgb(255,0,0);	//红色
          // var color = d3.interpolate(a,b);

          // var damagecolor = color(0.9)
          // vergroup[8].stroke = damagecolor
          // vergroup[9].stroke = damagecolor
          // horgroup[4].stroke = damagecolor

          // Don't forget to tell two to render everything
          // to the screen
          two.update();
        }
      )
    );
    // ======================================================================
    //                                                                      |
    //                            可视化损伤结果                              |
    //                                                                      |
    // ------------------------------ 功能 ----------------------------------
    //                                                                      |
    // 当你输入剩下参数并按下 Calculate 按钮时候 --画出损伤图                   |
    //                                                                      |
    // ------------------------------ 参考 ----------------------------------
    //                                                                      |
    // 全程使用 D3.js 库：https://d3js.org/                                  |
    //					 https://github.com/d3/d3/wiki                              |
    //					 https://www.d3-graph-gallery.com/                          |
    //					 https://www.d3-graph-gallery.com/barplot.html              |
    // 建议细读文档与例子看懂下面的代码                                       	|
    //                                                                      |
    // ======================================================================
    $(document).ready(
      $("#Calculate").click(
        async function () {
          // ===================== Part A =========================
          //                                                      |
          //       			这是需要注意的地方                   	      |
          //                                                      |
          // 以下代码属于获取数据并计算损伤的全过程。 (已注释)        	|
          // 得依赖python的函数才能计算并得到用于画图用的损伤数据。  	|
          // 单纯网页没有办法获得数据，所以先采用下一段人为构造的一组	  |
          // 损伤数据（Part B）作为可视化的输入。                    	|
          //                                                      |
          // ======================================================
          // 清空作图区域。
          $("#draw-bar").empty();
          // 获取所有需要用到的参数。
          var csvfile = localStorage.getItem("csvfile");              // 文件路径。
          var numelem = Number($("#numelem").val());                  // 单元数。
          var modeltype = $("#modeltype").val();                      // 模型类型。
          var goaltype = $("#goaltype").val();                        // 目标函数类型。
          var MeasuredNodes = JSON.parse($("#MeasuredNodes").val());	// 测点。
          var orderuse = JSON.parse($("#orderuse").val());            // 用到的频率阶数。
          var DirDOF = JSON.parse($("#DirDOF").val());                // 固定的自由度。
          var TolLen = Number($("#TolLen").val());                    // 梁的总长度。
          var rho = Number($("#rho").val());                          // 密度。
          var E = Number($("#beamE").val());                          // 弹性模量。
          var area = Number($("#area").val());                        // 梁横截面积。
          var Im = Number($("#Im").val());                            // 梁截面惯性矩。
          var tol = Number($("#tol").val());                          // 收敛标准的容许误差。
          var nmax = Number($("#nmax").val());                        // 最大迭代步数。
          // 检查是否采用正则化。
          if ($("#L1reg").is(':checked')) {
          	// 获取 L1 正则化需要的超参数。
          	var alpha = Number($("#L1-alpha").val());
          	var lmax = Number($("#L1-lmax").val());
          	// 控制台输出参数，以便查看数据类型和数据是否正确。
          	// console.log('numelem:',typeof numelem);
          	// console.log(numelem);
          	// console.log('modeltype:',typeof modeltype);
          	// console.log(modeltype);
          	// console.log('goaltype:',typeof goaltype);
          	// console.log(goaltype);
          	// console.log('MeasuredNodes:',typeof MeasuredNodes);
          	// console.log(MeasuredNodes);
          	// console.log('orderuse:',typeof orderuse);
          	// console.log(orderuse);
          	// console.log('alpha:',typeof alpha);
          	// console.log(alpha);
          	// console.log('lmax:',typeof lmax);
          	// console.log(lmax);
            // console.log('tol:',typeof tol);
            // console.log(tol);
            // console.log('nmax:',typeof nmax);
            // console.log(nmax);
          // 调用后台python的BeamDetect函数进行损伤计算并保存返回的结果于stiff。

          // var stiff = await eel.BeamDetect(modeltype,goaltype,csvfile,numelem,MeasuredNodes,
          //             orderuse,DirDOF,TolLen,E,rho,area,Im,lmax,alpha,tol,nmax)();

          // 控制台输出结果，检查是否正确。
          // console.log(stiff)
          // console.log(typeof stiff)
          } else { 
          // 如果不进行正则化，有待完成...
          // 	console.log(dof,modeltype,goaltype,MeasuredNodes,orderuse);
          }

          // ===================== Part B =========================
          //                                                      |
          //       			这是需要注意的地方                   	      |
          //                                                      |
          // 以下代码属于人为构造的一组损伤数据作为可视化的输入。       |
          //                                                      |
          // ======================================================				
          const stiff = [{ 'dof': 1, 'value': 1.00 }, { 'dof': 2, 'value': 1.00 },
                         { 'dof': 3, 'value': 1.00 }, { 'dof': 4, 'value': 1.00 },
                         { 'dof': 5, 'value': 0.90 }, { 'dof': 6, 'value': 1.00 },
                         { 'dof': 7, 'value': 1.00 }, { 'dof': 8, 'value': 1.00 }];
          // ===================== Part C =========================
          //                                                      |
          //                可视化过程                             |
          //                                                      |
          // 以下代码属于人为构造的一组损伤数据作为可视化的输入。       |
          //                                                      |
          // ======================================================	
          // 为了对齐左侧结构图，定义一些边界长度(margin)。
          var margin = { top: topp, right: 30, bottom: 30, left: 30, text: 60 };
          var width = $("#draw-bar").width();
          var height = $("#draw-shapes svg").height() + margin.text;

          // 创建画布。
          var svg = await d3.select("#draw-bar")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform",
              "translate(" + margin.left + "," + margin.top + ")");

          // console.log(svg, width, height);

          // 创建 X 轴。
          var x = d3.scaleLinear()
            .domain([0, 1])
            .range([0, width - margin.right - margin.left]);
          svg.append("g")
            .attr("id", "xaxis")
            .attr("transform", "translate(0," + dof * len + ")")
            .call(d3.axisBottom(x))
            .style("font-size", "16px")
            .selectAll("text")
            .attr("transform", "translate(-10,0)rotate(-45)")
            .style("text-anchor", "end");

          // 创建 Y 轴。
          // console.log(dof)
          // console.log(Array.from(new Array(Number(dof)), (x, i) => i + 1).reverse())
          var y = d3.scaleBand()
            .range([0, height - margin.top - margin.bottom - margin.text])
            .domain(Array.from(new Array(Number(dof)), (x, i) => i + 1).reverse())
            .padding(.1);

          svg.append("g")
            .attr("id", "yaxis")
            .call(d3.axisLeft(y))
            .style("font-size", "20px")

          var barGroups = svg.selectAll("myRect")
            .data(stiff)
            .enter()
            .append('g')
            .attr("class", "bar")

          barGroups
            .append("rect")
            .attr("x", x(0))
            .attr("y", (d) => y(d.dof))
            .attr("width", (d) => x(0))
            .attr("height", y.bandwidth())
            .attr("fill", "#69b3a2");

          barGroups
            .append('text')
            .attr("id", "bartext")
            .attr('x', (a) => x(1-a.value) - 30)
            .attr('y', (a) => y(a.dof) + y.bandwidth() / 2 + 12)
            .attr('text-anchor', 'middle')
            .attr("font-size", '12px')
            .attr("font-family", 'sans-serif')
            // .text(a => 1-a.value)

          // 动画。
          svg.selectAll("rect")
            .transition()
            .duration(800)
            .attr("width", (d) => x(1-d.value))
            .delay(function (d, i) { return (i * 100) })

          // svg.append('text')
          //   .attr('class', 'labeltext')
          //   .attr('x', (width - margin.left - margin.right) / 2)
          //   .attr('y', height - margin.top - margin.bottom + margin.text / 4)
          //   .attr('text-anchor', 'middle')
          //   .attr("font-size", '12px')
          //   .attr("font-family", 'sans-serif')
          //   .text('Stiff Ratio')


          d3.selectAll("#yaxis text").attr("fill", "#888");
          d3.selectAll(".bar text").attr("fill", "#fff");
          // d3.selectAll(".label text").attr("font-size", "20px");
        }
      )
    );

    // 获取文件路径。
    $(document).ready(
      $("#submitbtn").click(async function () {
        var filepath = await eel.getPath()();
        var extStart = filepath.lastIndexOf('.');
        ext = filepath.substring(extStart, filepath.length).toUpperCase();
        if (ext !== '.CSV') {
          $('.submitWord').html("上传文件出错！");
        } else {
          localStorage.setItem("csvfile", filepath);
          $('.submitWord').html(filepath);
          console.log(localStorage.getItem("csvfile"));
        }
      })
    );

  </script>

</body>

</html>