<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
  <title>SDIDS</title>
  <link rel="stylesheet" type="text/css" href="./css/min.css">
  <link rel="stylesheet" type="text/css" href="./css/bootstrap.min.css" >
  <script type='text/javascript' src='/eel.js'></script>
  <script src="./js/min.js?v=3"></script>
</head>
<body>
  <div class="main-content">
    <div id="header" class="col-12">
        <!-- <h2 class="text-light text-left align-middle"> Structure Damage Identification and Diagnosis System </h1>  -->
        <img src="./images/title.png" class="rounded float-left" alt=""> 
    </div>

    <div id="content" class="container-fluid">
      <div class="row">
        <div id="jscad-container" class="col-md-5 jscad-container">
          <div oncontextmenu="return false;" id="viewerContext" design-url="storey-options.jscad"></div> 
        </div>
        <div id="control-container" class="col-md-2 order-first scrollbar-ripe-malinka sidebar">
          <div class="col-12 strike text-muted" id="modelcontrol">
            <span> 模态分析 </span>
          </div>
          <div class="form-group row">
            <label for="modeltype" class="col-sm-5 col-form-label text-left">分析方法</label>
            <div class="col-sm-7">
              <select class="form-control" id="modeltype">
                <option value=""></option>
                <option value="1">FDD</option>
                <option value="2">SSI</option>
              </select> 
            </div>
          </div>
          <div class="col-12 strike text-muted" id="parametercontrol">
            <span> 参 数 </span>
          </div>
          <div id="FDD-control" class="control-form d-none">
            <div class="form-group row">
              <label for="FDD-selectbtn" class="col-sm-5 col-form-label text-left">选择数据</label>
              <div class="col-sm-7 overflow-hidden">
                <span>
                  <button type="submit" class="btn btn-primary select-btn" value="getdatafile" id="FDD-selectbtn">
                    Select
                  </button>
                </span>
                <span class="submitWord ">未选择数据。</span>
              </div>
            </div>
            <div class="form-group row">
              <label for="fddFs" class="col-sm-5 col-form-label text-left">采样频率</label>
              <div class="col-sm-7">
                <input type="text" class="form-control" id="fddFs", value="500">
              </div>
            </div>
            <div class="form-group row">
              <label for="fddNfft" class="col-sm-5 col-form-label text-left">傅里叶变换长度</label>
              <div class="col-sm-7">
                <input type="text" class="form-control" id="fddNfft", value="1024">
              </div>
            </div>
            <div class="form-group row">
              <label for="fddNperseg" class="col-sm-5 col-form-label text-left">窗口长度</label>
              <div class="col-sm-7">
                <input type="text" class="form-control" id="fddNperseg", value="1024">
              </div>
            </div>
            <div class="form-group row">
              <label for="fddNoverlap" class="col-sm-5 col-form-label text-left">重叠长度</label>
              <div class="col-sm-7">
                <input type="text" class="form-control" id="fddNoverlap", value="512">
              </div>
            </div>
            <div class="form-group row">
              <label for="fddWindow" class="col-sm-5 col-form-label text-left">窗口类型</label>
              <div class="col-sm-7">
                <select class="form-control" id="fddWindow">
                  <option>汉宁窗</option>
                  <option>汉明型</option>
                  <option>Boxcar</option>
                  <option>巴特利特窗</option>
                  <option>三角窗</option>
                </select> 
              </div>
            </div>
            <div class="form-group row">
              <label for="fddAverage" class="col-sm-5 col-form-label text-left">平均方式</label>
              <div class="col-sm-7">
                <select class="form-control" id="fddAverage">
                  <option>Mean</option>
                  <option>Median</option>
                </select> 
              </div>
            </div>
            <div class="col-sm-12 p-2">
              <button class="btn btn-primary btn-block calculate">
                计算模态
              </button>  
            </div>           
          </div>
          <div id="SSI-control" class="control-form d-none">
            <div class="form-group row">
              <label for="SSI-selectbtn" class="col-sm-5 col-form-label text-left">选择数据</label>
              <div class="col-sm-7">
                <span>
                  <button type="submit" class="btn btn-primary select-btn" value="getdatafile" id="SSI-selectbtn">
                    Select
                  </button>
                </span>
                <span class="submitWord">未选择数据。</span>
              </div>
            </div>
            <div class="form-group row">
              <label for="ssiFs" class="col-sm-5 col-form-label text-left">采样频率</label>
              <div class="col-sm-7">
                <input type="text" class="form-control" id="ssiFs", value="500">
              </div>
            </div>
            <div class="form-group row">
              <label for="ssiOrder" class="col-sm-5 col-form-label text-left">计算模态阶数</label>
              <div class="col-sm-7">
                <input type="text" class="form-control" id="ssiOrder", value="8">
              </div>
            </div>
            <div class="form-group row">
              <label for="ssiNs" class="col-sm-5 col-form-label text-left">Hankel矩阵维度</label>
              <div class="col-sm-7">
                <input type="text" class="form-control" id="ssiNs", value="100">
              </div>
            </div>
            <div class="col-sm-12 p-2">
              <button class="btn btn-primary btn-block calculate">
                计算模态
              </button>
            </div>          
          </div>
<!--           <div class="col-md-6 form-group">
            <strong class="text-muted mb-1">
              <label for="modeltype">模型类型</label>           
            </strong>
            <select class="form-control" id="modeltype">
              <option>剪切层</option>
              <option>悬臂梁</option>
            </select>   
          </div> 
          <div class="col-md-6 form-group">
            <strong class="text-muted mb-1">
              <label for="goaltype">目标函数类型</label>
            </strong>
            <select class="form-control" id="goaltype">
              <option>解耦型</option>
              <option>耦合型</option>
            </select>   
          </div> -->
        </div>
        <div id="result-container" class="col-md-4 order-last">
          <div id="drawbard"
            style="height: auto; width: 100% ;margin: 0;padding: 0; margin:0px;">
            <div class="col-12 strike text-muted" id="modelcontrol">
                <span> 模态分析结果 </span>
              </div>
            <canvas id="barChart" style="height: auto; width: 100% "> <!--   ;border:5px solid; border-color: crimson border:5px solid; border-color: rgb(73, 20, 220)-->
              你的浏览器不支持HTML5 canvas </canvas> 
          </div>
            
          <div id="tail" style="display: none;">
            <div id="statusdiv"></div>
            <input id="stateDiv" value="0">
            <button id="stateButton"></button>
          </div>
        </div>  
  
      </div>
    </div>

  </div>

<script src="./js/jquery-3.4.1.min.js"></script>
<script src="./js/goBarChartH.js"></script>
<script>
  
  // 参数控制选择隐藏与显示。
  $(document).ready(
    $("#modeltype").change(
      function() {
        console.log(this.value)
        switch (this.value) {
          case '1':
            console.log(typeof this.value)
            var c = document.querySelectorAll('.control-form');
            var i;
            for (var i=0; i<c.length; i++) {
              c[i].className = 'control-form d-none';
            }
            $('#FDD-control').attr('class', 'control-form d-block');
            break;
          case '2':
            var c = document.querySelectorAll('.control-form');
            var i;
            for (var i=0; i<c.length; i++) {
              c[i].className = 'control-form d-none';
            }
            $('#SSI-control').attr('class', 'control-form d-block');
            break;
        }
      })
    )
  // 
  $(document).ready(
    $(".calculate").click(
      async function () {
        // console.log(typeof($("#modeltype").val()),$("#modeltype").val());
        switch (Number($("#modeltype").val())){
          case 1:
            var csvfile = localStorage.getItem("csvfile");      // 文件路径。
            var fddFs = Number($("#fddFs").val());              // 采样频率。
            var fddNfft = Number($("#fddNfft").val());          // 傅里叶变换长度。
            var fddNperseg = Number($("#fddNperseg").val());    // 窗口长度。
            var fddNoverlap = Number($("#fddNoverlap").val());  // 重叠长度。
            var fddWindow = $("#fddWindow").val();              // 目标函数类型。
            var fddAverage = $("#fddAverage").val();            // 平均方式。
            //  // 控制台输出参数，以便查看数据类型和数据是否正确。
            console.log('fddFs:',typeof fddFs);
            console.log(fddFs);
            console.log('fddNfft:',typeof fddNfft);
            console.log(fddNfft);
            console.log('fddNperseg:',typeof fddNperseg);
            console.log(fddNperseg);
            console.log('fddNoverlap:',typeof fddNoverlap);
            console.log(fddNoverlap);
            console.log('fddWindow:',typeof fddWindow);
            console.log(fddWindow);
            console.log('fddAverage:',typeof fddAverage);
            console.log(fddAverage);

            // // 调用后台python的FDD函数进行模态分析并保存返回的结果于mode。
              // var stiff = await eel.StoreyDetect(goaltype,localStorage.
              //   getItem("csvfile"),dof,effdof,orderuse,lmax,alpha,tol,nmax)();
            var mode = await eel.FDD(csvfile, fddFs, fddNfft, fddWindow)();
            // // 控制台输出结果，检查是否正确。
            // console.log(mode)
            // console.log(typeof mode)
            var state = await eel.creatStoreyModeShapeJSCAD(mode, order, dof);
            if (state == 1){
              $('#stateDiv').attr('value','1');
            }
             break;
          case 2:
            // 获取所有需要用到的参数。
            var csvfile = localStorage.getItem("csvfile");        // 文件路径。
            var ssiFs = Number($("#ssiFs").val());                // 采样频率。          
            var ssiOrder = Number($("#ssiOrder").val());          // 计算模态阶数。
            var ssiNs = Number($("#ssiNs").val());                // Hankel矩阵维度。
              // 控制台输出参数，以便查看数据类型和数据是否正确。
            console.log('ssiFs:',typeof ssiFs);
            console.log(ssiFs);
            console.log('ssiOrder:',typeof ssiOrder);
            console.log(ssiOrder);
            console.log('ssiNs:',typeof ssiNs);
            console.log(ssiNs);
            // 调用后台python的SSI函数进行模态分析并保存返回的结果于mode。
            // var stiff = await eel.BeamDetect(goaltype,csvfile,numelem,MeasuredNodes,
            //             orderuse,DirDOF,TolLen,E,rho,area,Im,lmax,alpha,tol,nmax)();
            var mode = await eel.SSI(csvfile, ssiFs, ssiOrder, ssiNs)();
            // 控制台输出结果，检查是否正确。
            console.log(mode);
            console.log(typeof mode);
            var state = await eel.creatStoreyModeShapeJSCAD(mode, ssiOrder, 21)();
            console.log(typeof state);
            if (state == 1){
              console.log('hello');
              $('#stateButton').click();
            }
            break;
        } // SWITCH

// <!-- --------------------------------下--------------------------------------------- -->
  // var numelem = 8;
  // var stiff = [{ 'dof': 1, 'value': 1.00 }, { 'dof': 2, 'value': 1.00 }, { 'dof': 3, 'value': 0.9 }, { 'dof': 4, 'value': 1.00 },
  // { 'dof': 5, 'value': 0.95 },{ 'dof': 6, 'value': 0.95 },{ 'dof': 7, 'value': 0.85 },{ 'dof': 8, 'value': 0.9}];
  // numelem=stiff.length
  // var sx = Array.from({ length: numelem }, (item, index) => index + 1);
  // var stiffvalue = new Array(numelem)
  // for (i = 0; i < stiff.length; i++) {
  //   stiffvalue[i] = 1- stiff[i].value;
  // }
  // var AALL = new Array(numelem)
  // for (i = 0; i < stiff.length; i++) {
  //   AALL[i] = [sx[i], stiffvalue[i]]
  // }
  // // [[1,0.9]]
  // $(window).resize(resizeCanvas);
  // function resizeCanvas() {
  //   $("#barChart").attr("width", $(window).get(0).innerWidth);
  //   $("#barChart").attr("height", $(window).get(0).innerHeight);
  //   canvas = document.getElementById("barChart");
  //   ctx = canvas.getContext("2d");
  //   ctx.fillRect(0, 0, canvas.width, canvas.height);
  //   goBarChartH(AALL)
  // };
  // resizeCanvas();

  //  <!-- --------------------------------上--------------------------------------------- -->
      } // click 下的function
    )
  );

  // 获取文件路径。
  $(document).ready(
    $(".select-btn").click(async function () {
      var filepath = await eel.getPath()();
      var extStart = filepath.lastIndexOf('.');
      ext = filepath.substring(extStart, filepath.length).toUpperCase();
      if (ext !== '.CSV') {
        $('.submitWord').html("上传文件出错！");
      } else {
        localStorage.setItem("csvfile", filepath);
        $('.submitWord').html(filepath);
        console.log(localStorage.getItem("csvfile"));
      }
    })
  );
</script>


</body>
</html>
